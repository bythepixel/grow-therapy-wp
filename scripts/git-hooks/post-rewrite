#!/bin/bash

# Post-rewrite hook: Sync BricksSync changes from production after rebase
# This ensures devs have latest client changes when rebasing with staging

if [[ "$1" == "rebase" ]]; then
    # Sync in two scenarios:
    # 1. When rebasing with staging branch (any current branch)
    # 2. When on staging branch and rebasing with main
    current_branch=$(git branch --show-current)
    
    # Check if we're rebasing with staging
    if git reflog --oneline -1 | grep -q "rebase.*staging"; then
        should_sync=true
    # Or check if we're on staging and rebasing with main
    elif [[ "$current_branch" == "staging" ]] && git reflog --oneline -1 | grep -q "rebase.*main"; then
        should_sync=true
    else
        should_sync=false
    fi
    
    if [[ "$should_sync" == "true" ]]; then
        echo ""
        echo "Rebase completed - syncing with production BricksSync changes..."
        
        # Check if sync script exists
        if [[ -f "scripts/sync-production-brickssync.sh" ]]; then
            echo "Syncing latest production changes..."
            ./scripts/sync-production-brickssync.sh
            
            # Check for conflicts
            if git diff --name-only --diff-filter=U | grep -q "brickssync-json"; then
                echo "WARNING: Conflicts detected in BricksSync files"
                echo "Review and resolve conflicts before continuing"
            else
                echo "SUCCESS: Production changes synced successfully!"
            fi
        else
            echo "WARNING: Sync script not found: scripts/sync-production-brickssync.sh"
        fi
        fi
    fi
fi
