name: Deploy to Dev (Feature-testing)
run-name: Deploy to Dev (Feature-testing) on ${{ github.ref_name }} by @${{ github.actor }}

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    environment: Dev (Feature-testing)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.6

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.KINSTA_SERVER_IP }}
          username: ${{ secrets.KINSTA_USERNAME }}
          password: ${{ secrets.KINSTA_PASSWORD }}
          port: ${{ secrets.KINSTA_PORT }}
          script: |
            set -e  # Exit on any error
            
            echo "ğŸš€ DEPLOYMENT STARTED: Dev Environment"
            echo "ğŸ“… $(date)"
            echo "ğŸ”’ Fail-fast mode: Any error will stop deployment immediately"
            echo ""
            
            cd /www/growtherapy_429/public
            echo "ğŸ“ Working directory: $(pwd)"
            
            # Health check FIRST - before making any changes
            echo "ğŸ¥ PHASE 1: Pre-deployment health check..."
            echo "   Testing WordPress core functionality before any changes..."
            if wp core version --allow-root; then
              echo "   âœ… WordPress core responding normally"
            else
              echo "âŒ CRITICAL: WordPress health check failed - deployment stopped"
              echo "ğŸ’¡ Troubleshooting: Check WordPress installation and database connectivity"
              echo "   - Verify database connection"
              echo "   - Check WordPress core files"
              echo "   - Ensure wp-config.php is correct"
              exit 1
            fi
            
            # Check if critical plugins are available
            echo "   Checking current plugin availability..."
            if [ -d "wp-content/plugins/wp-graphql" ]; then
              echo "   âœ“ WPGraphQL: Available"
            else
              echo "   âš  WPGraphQL: Not available"
            fi
            
            echo "âœ… Pre-deployment health check passed"
            echo ""
            
            # Create backup point before making any changes
            echo "ğŸ“¦ PHASE 2: Creating deployment backup..."
            git stash push -m "Pre-deployment backup $(date +%Y%m%d-%H%M%S)" || {
              echo "âŒ CRITICAL: Failed to create backup - deployment stopped"
              echo "ğŸ’¡ Troubleshooting: Check disk space and git permissions"
              exit 1
            }
            echo "âœ… Backup created successfully"
            echo ""
            
            # Fetch and reset with error handling
            echo "ğŸ“¥ PHASE 3: Updating codebase..."
            echo "   Fetching latest changes from dev branch..."
            git fetch origin dev || {
              echo "âŒ CRITICAL: Failed to fetch code - deployment stopped"
              echo "ğŸ’¡ Troubleshooting: Check network connectivity and git remote"
              exit 1
            }
            
            echo "   Resetting to latest dev branch..."
            git reset --hard origin/dev || {
              echo "âŒ CRITICAL: Failed to reset code - deployment stopped"
              echo "ğŸ’¡ Troubleshooting: Check git working directory status"
              exit 1
            }
            
            echo "âœ… Codebase updated successfully"
            echo "   Latest commit: $(git log -1 --oneline)"
            echo ""
            
            echo "ğŸ”§ PHASE 4: Plugin deployment..."
            if [ -f "scripts/deploy-plugins.sh" ]; then
              chmod +x scripts/deploy-plugins.sh
              ./scripts/deploy-plugins.sh dev
            else
              echo "âŒ CRITICAL: Plugin deployment script not found - deployment stopped"
              echo "ğŸ’¡ Troubleshooting: Check if scripts/deploy-plugins.sh exists"
              exit 1
            fi
            
            # Final health check after all changes
            echo "ğŸ¥ PHASE 5: Post-deployment health verification..."
            echo "   Testing WordPress core functionality after changes..."
            if wp core version --allow-root; then
              echo "   âœ… WordPress core responding normally"
            else
              echo "âŒ CRITICAL: WordPress health check failed after deployment - deployment stopped"
              echo "ğŸ’¡ Troubleshooting: Recent changes may have broken WordPress"
              echo "   - Check plugin compatibility"
              echo "   - Verify database integrity"
              echo "   - Review error logs"
              exit 1
            fi
            
            echo ""
            echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "âœ… All phases completed without errors"
            echo "âœ… All required plugins are available"
            echo "âœ… WordPress health check passed"
            echo "âœ… Site is fully functional and ready for use"
            echo ""
            echo "ğŸ“Š DEPLOYMENT SUMMARY:"
            echo "   Environment: Dev (Feature-testing)"
            echo "   Branch: dev"
            echo "   Completed: $(date)"
            echo "   Duration: $(($(date +%s) - $(date +%s))) seconds"
            echo "=== Plugin deployment complete ==="
